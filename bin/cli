#!/usr/bin/env php
<?php
declare(strict_types=1);

use Ahc\Cli\IO\Interactor;
use Doctrine\ORM\EntityManagerInterface;
use Noodlehaus\ConfigInterface;
use Psr\Container\ContainerInterface;
use Stu\Component\Cli\ColonyTickCommand;
use Stu\Component\Cli\MaintenanceTickCommand;
use Stu\Component\Cli\ManagerTickCommand;
use Stu\Component\Cli\ProcessTickCommand;
use Stu\Component\Cli\ShipTickCommand;
use Stu\Component\Cli\UserCreateCommand;
use Stu\Config\Init;

require_once __DIR__ . '/../vendor/autoload.php';

Init::run(
    function (ContainerInterface $dic): void {
      /**
       * @todo Remove after magic dic calls have been purged
       */
      global $container;
      $container = $dic;

      $em = $dic->get(EntityManagerInterface::class);

        $em->beginTransaction();

        $app = new Ahc\Cli\Application(
            'Star Trek Universe CLI',
            (string) $dic->get(ConfigInterface::class)->get('game.version'),
            function (int $exitCode = 0) use ($em): void {
                if ($exitCode === 0) {
                    $em->flush();
                    $em->commit();
                } else {
                    $em->rollback();
                }
                exit($exitCode);
            }
        );
        $app->io(new Interactor());

        $logo = <<<LOGO
              .dBBBBP  dBBBBBBP dBP dBP    dBBBP  dBP    dBP
              BP
              `BBBBb    dBP   dBP dBP    dBP    dBP    dBP
                 dBP   dBP   dBP_dBP    dBP    dBP    dBP
            dBBBBP'   dBP   dBBBBBP    dBBBBP dBBBBP dBP
            LOGO;

        $app->logo($logo);
        $app->add(new UserCreateCommand($dic));
        $app->add(new ColonyTickCommand($dic));
        $app->add(new ShipTickCommand($dic));
        $app->add(new MaintenanceTickCommand($dic));
        $app->add(new ProcessTickCommand($dic));
        $app->add(new ManagerTickCommand($dic));

        $app->handle($_SERVER['argv']);
    }
);
